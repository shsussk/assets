<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard I+D ¬∑ Plantaciones del Norte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --color-primary: #4caf50;
      --color-primary-light: #dcf4dc;
      --color-accent: #f9a825;
      --color-success: #4caf50;
      --color-warning: #ff9800;
      --color-danger: #f44336;
      --color-info: #2196f3;
      --color-bg: #f8fafb;
      --color-card: white;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-md: 0 8px 24px rgba(0,0,0,0.12);
      --radius: 12px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: var(--color-bg); color: #333; line-height: 1.6; }

    .dashboard { min-height: 100vh; padding: 24px; max-width: 1400px; margin: 0 auto; }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
      flex-wrap: wrap;
      gap: 10px;
    }
    .header h1 { font-size: 2rem; color: var(--color-primary); font-weight: 700; }

    .header-buttons {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      background: var(--color-primary);
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      text-decoration: none;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    .btn:hover { opacity: 0.92; transform: translateY(-1px); }
    .btn-secondary { background: #6c757d; }
    .btn-danger { background: #f44336; }

    .nav-shortcuts { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 24px; }
    .btn-nav {
      background: var(--color-primary);
      color: #fff;
      text-decoration: none;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-nav:hover { background: #43a047; transform: translateY(-1px); }

    .kpis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
    .kpi-card {
      background: var(--color-card);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      border-left: 4px solid var(--color-primary);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .kpi-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .kpi-icon { font-size: 1.4rem; margin-bottom: 8px; }
    .kpi-value { font-size: 2rem; font-weight: 800; margin-bottom: 2px; }
    .kpi-label { font-size: 0.8rem; color: #666; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
    .kpi-detail { font-size: 0.85rem; color: #888; }

    .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px; }
    .chart-container { background: var(--color-card); padding: 24px; border-radius: var(--radius); box-shadow: var(--shadow-sm); }
    .chart-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; }

    .tables-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
    .table-container { background: var(--color-card); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow-sm); }
    .table-header { background: var(--color-primary-light); padding: 14px 18px; font-weight: 600; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 14px; text-align: left; border-bottom: 1px solid #f1f5f9; }
    th { background: #f8fafc; font-weight: 600; font-size: 0.8rem; color: #666; text-transform: uppercase; }
    tr:hover { background: #f8fafc; cursor: pointer; }
    .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
    .status-activo { background: #dcf4dc; color: var(--color-success); }

    @media (max-width: 1024px) { .charts-grid, .tables-grid { grid-template-columns: 1fr; } }
    @media (max-width: 768px) { .kpis-grid { grid-template-columns: 1fr 1fr; } .dashboard { padding: 16px; } }
    @media (max-width: 480px) { .kpis-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="dashboard">
    <header class="header">
      <h1>üìä Dashboard I+D</h1>
      <div class="header-buttons">
        <span id="userInfo" style="font-size:0.85rem;color:#666;"></span>
        <a href="admin-usuarios.html" class="btn btn-secondary" id="btnAdmin" style="display:none;">üîê Usuarios</a>
        <a href="index.html" class="btn btn-secondary">‚Üê Inicio</a>
        <button onclick="cerrarSesion()" class="btn btn-danger">Cerrar sesi√≥n</button>
      </div>
    </header>

    <nav class="nav-shortcuts">
      <a href="ensayos.html" class="btn-nav">üß™ Ensayos</a>
      <a href="problemas.html" class="btn-nav">‚ö†Ô∏è Problemas</a>
      <a href="colaboradores.html" class="btn-nav">ü§ù Colaboradores</a>
      <a href="historias.html" class="btn-nav">üå± Historias de √âxito</a>
      <a href="analytics.html" class="btn-nav">üìà Centro de Anal√≠tica</a>
    </nav>

    <div class="kpis-grid">
      <div class="kpi-card">
        <div class="kpi-icon">üß™</div>
        <div id="kpiEnsayosActivos" class="kpi-value">0</div>
        <div class="kpi-label">Ensayos Activos</div>
        <div id="kpiEnsayosActivosDetalle" class="kpi-detail"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">üìà</div>
        <div id="kpiRoiValor" class="kpi-value">0%</div>
        <div class="kpi-label">ROI Promedio</div>
        <div id="kpiRoiDetalle" class="kpi-detail"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">‚úÖ</div>
        <div id="kpiExitoValor" class="kpi-value">0%</div>
        <div class="kpi-label">Tasa de √âxito</div>
        <div id="kpiExitoDetalle" class="kpi-detail"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">üìÑ</div>
        <div id="kpiPublicacionesValor" class="kpi-value">0</div>
        <div class="kpi-label">Publicaciones</div>
        <div class="kpi-detail">Generadas por ensayos</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">‚ö†Ô∏è</div>
        <div id="kpiProblemasValor" class="kpi-value">0</div>
        <div class="kpi-label">Problemas Abiertos</div>
        <div id="kpiProblemasDetalle" class="kpi-detail"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">üë•</div>
        <div id="kpiColaboradoresValor" class="kpi-value">0</div>
        <div class="kpi-label">Colaboradores Activos</div>
        <div id="kpiColaboradoresDetalle" class="kpi-detail"></div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-container">
        <div class="chart-title">üìä Ensayos por Estado</div>
        <canvas id="chartEnsayosEstado"></canvas>
      </div>
      <div class="chart-container">
        <div class="chart-title">üéØ Tasa de √âxito por √Årea</div>
        <canvas id="chartExitoArea"></canvas>
      </div>
    </div>

    <div class="tables-grid">
      <div class="table-container">
        <div class="table-header">üî¨ Ensayos Activos Principales</div>
        <table>
          <thead>
            <tr><th>√Årea</th><th>Responsable</th><th>Inicio</th><th>Avance</th><th>Estado</th></tr>
          </thead>
          <tbody id="tablaEnsayosActivos"></tbody>
        </table>
      </div>
      <div class="table-container">
        <div class="table-header">‚ö†Ô∏è Problemas Alta Prioridad</div>
        <table>
          <thead>
            <tr><th>Prioridad</th><th>√Årea</th><th>Fecha</th><th>Por</th></tr>
          </thead>
          <tbody id="tablaProblemasPrioridad"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    var chartEnsayos = null;
    var chartExito = null;

    function loadEnsayos() {
      var raw = localStorage.getItem('ensayos');
      return raw ? JSON.parse(raw) : [];
    }
    function loadProblemas() {
      var raw = localStorage.getItem('problemas');
      return raw ? JSON.parse(raw) : [];
    }
    function loadColaboradores() {
      var raw = localStorage.getItem('colaboradores');
      return raw ? JSON.parse(raw) : [];
    }
    function loadHistorias() {
      var raw = localStorage.getItem('historias_exito');
      return raw ? JSON.parse(raw) : [];
    }

    function actualizarDashboard() {
      var ensayos = loadEnsayos();
      var problemas = loadProblemas();
      var colaboradores = loadColaboradores();
      var historias = loadHistorias();

      actualizarKPIs(ensayos, problemas, colaboradores, historias);
      actualizarGraficoEnsayosPorEstado(ensayos);
      actualizarGraficoExitoPorArea(ensayos);
      actualizarTablaEnsayosActivos(ensayos);
      actualizarTablaProblemasPrioridad(problemas);
    }

    function actualizarKPIs(ensayos, problemas, colaboradores, historias) {
      var activos = ensayos.filter(function(e) { return e.estado === 'activo'; }).length;
      var total = ensayos.length;
      var finalizados = ensayos.filter(function(e) { return e.estado === 'finalizado'; }).length;
      document.getElementById('kpiEnsayosActivos').textContent = activos;
      document.getElementById('kpiEnsayosActivosDetalle').textContent =
        total > 0 ? Math.round((activos/total)*100) + '% del total (' + total + ' ensayos)' : 'Sin ensayos registrados';

      var roiActivos = ensayos.filter(function(e) { return e.estado === 'activo' && typeof e.roiEstimado === 'number' && e.roiEstimado > 0; });
      var roiProm = roiActivos.length
        ? (roiActivos.reduce(function(s,e) { return s + e.roiEstimado; }, 0) / roiActivos.length).toFixed(1)
        : 0;
      var roiNivel = roiProm >= 150 ? 'Alto' : roiProm >= 80 ? 'Medio' : 'Bajo';
      var roiColor = roiProm >= 150 ? '#4caf50' : roiProm >= 80 ? '#ff9800' : '#f44336';
      document.getElementById('kpiRoiValor').textContent = roiProm + '%';
      document.getElementById('kpiRoiDetalle').innerHTML =
        '<span style="color:' + roiColor + '">' + roiNivel + '</span> ¬∑ ' + roiActivos.length + ' ensayos con ROI';

      var exitosos = ensayos.filter(function(e) { return e.estado === 'finalizado' && e.exito; }).length;
      var tasaExito = finalizados > 0 ? ((exitosos / finalizados) * 100).toFixed(1) : 0;
      document.getElementById('kpiExitoValor').textContent = tasaExito + '%';
      document.getElementById('kpiExitoDetalle').textContent = exitosos + '/' + finalizados + ' ensayos finalizados';

      var publicaciones = ensayos.filter(function(e) { return (e.publicaciones || []).length > 0; }).length;
      document.getElementById('kpiPublicacionesValor').textContent = publicaciones;

      var abiertos = problemas.filter(function(p) { return p.estado === 'abierto' || p.estado === 'en proceso'; }).length;
      document.getElementById('kpiProblemasValor').textContent = abiertos;
      var porArea = {};
      problemas.filter(function(p) { return p.estado === 'abierto' || p.estado === 'en proceso'; }).forEach(function(p) {
        var a = p.area || 'Otro';
        porArea[a] = (porArea[a] || 0) + 1;
      });
      var detalleProblemas = Object.keys(porArea).map(function(a) { return a + ' ' + porArea[a]; }).join(', ');
      document.getElementById('kpiProblemasDetalle').textContent = detalleProblemas || 'Sin problemas abiertos';

      var colabActivos = colaboradores.filter(function(c) { return (c.proyectos_activos || []).length > 0; }).length;
      var colabTotal = colaboradores.length;
      document.getElementById('kpiColaboradoresValor').textContent = colabActivos;
      document.getElementById('kpiColaboradoresDetalle').textContent =
        colabTotal > 0 ? Math.round((colabActivos/colabTotal)*100) + '% del equipo (' + colabTotal + ' total)' : 'Sin colaboradores registrados';
    }

    function actualizarGraficoEnsayosPorEstado(ensayos) {
      var estados = {};
      ensayos.forEach(function(e) {
        var est = e.estado || 'sin estado';
        estados[est] = (estados[est] || 0) + 1;
      });

      var labels = Object.keys(estados);
      var data = Object.values(estados);
      var colores = { activo:'#4caf50', finalizado:'#2196f3', suspendido:'#ff9800', fallido:'#f44336' };
      var bgColors = labels.map(function(l) { return colores[l] || '#9e9e9e'; });

      var ctx = document.getElementById('chartEnsayosEstado').getContext('2d');
      if (chartEnsayos) chartEnsayos.destroy();
      chartEnsayos = new Chart(ctx, {
        type: 'bar',
        data: { labels: labels, datasets: [{ label: 'Cantidad', data: data, backgroundColor: bgColors }] },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });
    }

    function actualizarGraficoExitoPorArea(ensayos) {
      var map = {};
      ensayos.filter(function(e) { return e.estado === 'finalizado'; }).forEach(function(e) {
        var area = e.area || 'Otro';
        if (!map[area]) map[area] = { total: 0, exitosos: 0 };
        map[area].total++;
        if (e.exito) map[area].exitosos++;
      });

      var labels = Object.keys(map);
      var data = labels.map(function(a) { return map[a].total > 0 ? ((map[a].exitosos / map[a].total) * 100).toFixed(1) : 0; });
      var bgColors = ['#4caf50','#8bc34a','#cddc39','#f9a825','#ff9800','#2196f3'];

      var ctx = document.getElementById('chartExitoArea').getContext('2d');
      if (chartExito) chartExito.destroy();

      if (labels.length === 0) {
        chartExito = new Chart(ctx, {
          type: 'doughnut',
          data: { labels: ['Sin datos'], datasets: [{ data: [1], backgroundColor: ['#e0e0e0'] }] },
          options: { responsive: true }
        });
        return;
      }

      chartExito = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: labels, datasets: [{ data: data, backgroundColor: bgColors.slice(0, labels.length) }] },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }

    function actualizarTablaEnsayosActivos(ensayos) {
      var tbody = document.getElementById('tablaEnsayosActivos');
      tbody.innerHTML = '';
      var activos = ensayos.filter(function(e) { return e.estado === 'activo'; }).slice(0, 10);

      if (activos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;">Sin ensayos activos. Crea uno desde üß™ Ensayos.</td></tr>';
        return;
      }

      activos.forEach(function(e) {
        var tr = document.createElement('tr');
        tr.onclick = function() { window.location.href = 'ensayos.html'; };
        tr.innerHTML =
          '<td>' + (e.area || '') + '</td>' +
          '<td>' + (e.responsableId || '') + '</td>' +
          '<td>' + (e.fechaInicio ? new Date(e.fechaInicio).toLocaleDateString('es-DO') : '') + '</td>' +
          '<td>' + (e.porcentajeAvance || 0) + '%</td>' +
          '<td><span class="status-badge status-activo">Activo</span></td>';
        tbody.appendChild(tr);
      });
    }

    function actualizarTablaProblemasPrioridad(problemas) {
      var tbody = document.getElementById('tablaProblemasPrioridad');
      tbody.innerHTML = '';
      var criticos = problemas
        .filter(function(p) { return p.estado === 'abierto' || p.estado === 'en proceso'; })
        .sort(function(a,b) {
          var ord = { Alta: 0, Media: 1, Baja: 2 };
          return (ord[a.prioridad] || 3) - (ord[b.prioridad] || 3);
        })
        .slice(0, 8);

      if (criticos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999;">Sin problemas abiertos. ¬°Genial!</td></tr>';
        return;
      }

      var coloresPrioridad = { Alta: '#f44336', Media: '#ff9800', Baja: '#4caf50' };
      criticos.forEach(function(p) {
        var tr = document.createElement('tr');
        tr.onclick = function() { window.location.href = 'problemas.html'; };
        tr.innerHTML =
          '<td style="color:' + (coloresPrioridad[p.prioridad] || '#333') + ';font-weight:700;">' + (p.prioridad || '') + '</td>' +
          '<td>' + (p.area || '') + '</td>' +
          '<td>' + (p.fecha ? new Date(p.fecha).toLocaleDateString('es-DO') : '') + '</td>' +
          '<td>' + (p.reportadoPor || '') + '</td>';
        tbody.appendChild(tr);
      });
    }

    document.addEventListener('DOMContentLoaded', actualizarDashboard);

    window.addEventListener('message', function(event) {
      if (event.data && event.data.tipo === 'actualizarDashboard') {
        actualizarDashboard();
      }
    });

    setInterval(actualizarDashboard, 10000);
  </script>

  <script src="auth-guard.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (window.SESION) {
        document.getElementById('userInfo').textContent = 'üë§ ' + window.SESION.nombre + ' (' + window.SESION.rol + ')';
        if (window.esAdmin()) {
          document.getElementById('btnAdmin').style.display = 'inline-flex';
        }
      }
    });
  </script>
</body>
</html>


