<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Centro de Anal√≠tica ¬∑ Plantaciones del Norte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --color-primary: #4caf50;
      --color-bg: #f8fafb;
      --color-card: #ffffff;
      --shadow: 0 8px 24px rgba(0,0,0,0.08);
      --radius: 14px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: var(--color-bg); color: #333; }

    .page { max-width: 1400px; margin: 0 auto; padding: 24px; }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .header h1 { font-size: 2rem; color: var(--color-primary); }

    .header-buttons {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      background: var(--color-primary);
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      text-decoration: none;
      transition: all 0.2s;
    }

    .btn-secondary { background: #6c757d; }
    .btn-danger { background: #f44336; }
    .btn:hover { opacity: 0.92; }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 24px;
      background: var(--color-card);
      padding: 16px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .filter-group { display: flex; flex-direction: column; gap: 4px; }
    .filter-group label { font-size: 0.8rem; font-weight: 600; text-transform: uppercase; color: #555; }
    .filter-group select, .filter-group input {
      padding: 8px 12px;
      border: 1px solid #dde2eb;
      border-radius: 999px;
      font-size: 0.9rem;
      min-width: 150px;
    }

    .kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }

    .kpi {
      background: var(--color-card);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--color-primary);
    }

    .kpi-icon { font-size: 1.3rem; margin-bottom: 6px; }
    .kpi-value { font-size: 1.8rem; font-weight: 800; }
    .kpi-label { font-size: 0.8rem; color: #666; text-transform: uppercase; letter-spacing: 0.04em; }
    .kpi-detail { font-size: 0.82rem; color: #888; margin-top: 4px; }

    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 28px;
    }

    .chart-card {
      background: var(--color-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
    }

    .chart-card h3 { font-size: 1rem; margin-bottom: 12px; color: #444; }

    .full-width { grid-column: 1 / -1; }

    .table-section {
      background: var(--color-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      margin-bottom: 28px;
    }

    .table-header {
      background: #e8f4e8;
      padding: 14px 18px;
      font-weight: 600;
    }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 14px; text-align: left; border-bottom: 1px solid #f1f5f9; }
    th { background: #f8fafc; font-size: 0.8rem; text-transform: uppercase; color: #666; }
    tr:hover { background: #f8fafc; }

    .badge {
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .badge-activo { background: #dcf4dc; color: #4caf50; }
    .badge-finalizado { background: #d1ecf1; color: #17a2b8; }
    .badge-suspendido { background: #fff3cd; color: #ffc107; }
    .badge-fallido { background: #f8d7da; color: #dc3545; }

    .insights {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }

    .insight-card {
      background: var(--color-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      border-left: 4px solid #f9a825;
    }

    .insight-card h4 { font-size: 0.95rem; margin-bottom: 6px; color: #333; }
    .insight-card p { font-size: 0.85rem; color: #555; line-height: 1.5; }

    @media (max-width: 960px) {
      .charts-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 640px) {
      .kpis { grid-template-columns: 1fr 1fr; }
      .header { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <h1>üìà Centro de Anal√≠tica</h1>
      <div class="header-buttons">
        <span id="userInfo" style="font-size:0.85rem;color:#666;"></span>
        <a href="admin-usuarios.html" class="btn btn-secondary" id="btnAdmin" style="display:none;">üîê Usuarios</a>
        <a href="dashboard.html" class="btn btn-secondary">‚Üê Dashboard</a>
        <button onclick="cerrarSesion()" class="btn btn-danger">Cerrar sesi√≥n</button>
      </div>
    </header>

    <!-- Filtros globales -->
    <div class="filters">
      <div class="filter-group">
        <label>Per√≠odo</label>
        <select id="filtroPeriodo" onchange="actualizarTodo()">
          <option value="todo">Todo el tiempo</option>
          <option value="2026">2026</option>
          <option value="2025">2025</option>
          <option value="2024">2024</option>
          <option value="ultimo6m">√öltimos 6 meses</option>
          <option value="ultimo12m">√öltimos 12 meses</option>
        </select>
      </div>
      <div class="filter-group">
        <label>√Årea</label>
        <select id="filtroArea" onchange="actualizarTodo()">
          <option value="">Todas</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Estado</label>
        <select id="filtroEstado" onchange="actualizarTodo()">
          <option value="">Todos</option>
          <option value="activo">Activo</option>
          <option value="finalizado">Finalizado</option>
          <option value="suspendido">Suspendido</option>
          <option value="fallido">Fallido</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Prioridad</label>
        <select id="filtroPrioridad" onchange="actualizarTodo()">
          <option value="">Todas</option>
          <option value="Baja">Baja</option>
          <option value="Media">Media</option>
          <option value="Alta">Alta</option>
        </select>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi">
        <div class="kpi-icon">üß™</div>
        <div id="kpiTotal" class="kpi-value">0</div>
        <div class="kpi-label">Ensayos totales</div>
        <div id="kpiTotalDetalle" class="kpi-detail"></div>
      </div>
      <div class="kpi">
        <div class="kpi-icon">‚úÖ</div>
        <div id="kpiExito" class="kpi-value">0%</div>
        <div class="kpi-label">Tasa de √©xito</div>
        <div id="kpiExitoDetalle" class="kpi-detail"></div>
      </div>
      <div class="kpi">
        <div class="kpi-icon">üìà</div>
        <div id="kpiRoi" class="kpi-value">0%</div>
        <div class="kpi-label">ROI promedio</div>
        <div id="kpiRoiDetalle" class="kpi-detail"></div>
      </div>
      <div class="kpi">
        <div class="kpi-icon">‚è±Ô∏è</div>
        <div id="kpiDuracion" class="kpi-value">0d</div>
        <div class="kpi-label">Duraci√≥n promedio</div>
        <div id="kpiDuracionDetalle" class="kpi-detail"></div>
      </div>
      <div class="kpi">
        <div class="kpi-icon">‚ö†Ô∏è</div>
        <div id="kpiProblemas" class="kpi-value">0</div>
        <div class="kpi-label">Problemas abiertos</div>
        <div id="kpiProblemasDetalle" class="kpi-detail"></div>
      </div>
      <div class="kpi">
        <div class="kpi-icon">üå±</div>
        <div id="kpiHistorias" class="kpi-value">0</div>
        <div class="kpi-label">Historias de √©xito</div>
        <div id="kpiHistoriasDetalle" class="kpi-detail"></div>
      </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="charts-grid">
      <div class="chart-card">
        <h3>üìä Ensayos por Estado</h3>
        <canvas id="chartEstado"></canvas>
      </div>
      <div class="chart-card">
        <h3>üéØ Ensayos por √Årea</h3>
        <canvas id="chartArea"></canvas>
      </div>
      <div class="chart-card">
        <h3>üìà ROI por √Årea</h3>
        <canvas id="chartRoiArea"></canvas>
      </div>
      <div class="chart-card">
        <h3>üî• Prioridad de Ensayos</h3>
        <canvas id="chartPrioridad"></canvas>
      </div>
      <div class="chart-card full-width">
        <h3>üìÖ Ensayos creados por mes</h3>
        <canvas id="chartTimeline"></canvas>
      </div>
      <div class="chart-card">
        <h3>‚ö†Ô∏è Problemas por √Årea</h3>
        <canvas id="chartProblemasArea"></canvas>
      </div>
      <div class="chart-card">
        <h3>üë• Top Colaboradores (aportes)</h3>
        <canvas id="chartTopColaboradores"></canvas>
      </div>
    </div>

    <!-- Insights autom√°ticos -->
    <div id="insightsContainer" class="insights"></div>

    <!-- Tabla detallada -->
    <div class="table-section">
      <div class="table-header">üî¨ Detalle de Ensayos (filtrados)</div>
      <table>
        <thead>
          <tr>
            <th>√Årea</th>
            <th>M√©trica</th>
            <th>Responsable</th>
            <th>Prioridad</th>
            <th>Estado</th>
            <th>ROI %</th>
            <th>Avance</th>
            <th>Inicio</th>
          </tr>
        </thead>
        <tbody id="tablaDetalle"></tbody>
      </table>
    </div>
  </div>

  <script src="supabase-config.js"></script>
  <script>
    var charts = {};
    var ensayos = [];
    var problemas = [];
    var colaboradores = [];
    var historias = [];

    async function loadData() {
      var [eRes, pRes, cRes, hRes] = await Promise.all([
        DB.ensayos.listar(),
        DB.problemas.listar(),
        DB.colaboradores.listar(),
        DB.historias.listar()
      ]);
      ensayos = eRes.data || [];
      problemas = pRes.data || [];
      colaboradores = cRes.data || [];
      historias = hRes.data || [];
    }

    function filtrarEnsayos() {
      var periodo = document.getElementById('filtroPeriodo').value;
      var area = document.getElementById('filtroArea').value;
      var estado = document.getElementById('filtroEstado').value;
      var prioridad = document.getElementById('filtroPrioridad').value;

      var hoy = new Date();
      var lista = ensayos.slice();

      lista = lista.filter(function(e) {
        if (area && e.area !== area) return false;
        if (estado && e.estado !== estado) return false;
        if (prioridad && e.prioridad !== prioridad) return false;

        if (periodo !== 'todo' && e.fecha_inicio) {
          var fi = new Date(e.fecha_inicio);
          if (periodo === 'ultimo6m') {
            var hace6 = new Date(hoy);
            hace6.setMonth(hace6.getMonth() - 6);
            if (fi < hace6) return false;
          } else if (periodo === 'ultimo12m') {
            var hace12 = new Date(hoy);
            hace12.setMonth(hace12.getMonth() - 12);
            if (fi < hace12) return false;
          } else {
            if (fi.getFullYear().toString() !== periodo) return false;
          }
        }
        return true;
      });

      return lista;
    }

    function filtrarProblemas() {
      var area = document.getElementById('filtroArea').value;
      return problemas.filter(function(p) {
        if (area && p.area !== area) return false;
        return true;
      });
    }

    function actualizarSelectAreas() {
      var areas = {};
      ensayos.forEach(function(e) { if (e.area) areas[e.area] = true; });
      problemas.forEach(function(p) { if (p.area) areas[p.area] = true; });

      var sel = document.getElementById('filtroArea');
      sel.innerHTML = '<option value="">Todas</option>';
      Object.keys(areas).sort().forEach(function(a) {
        var opt = document.createElement('option');
        opt.value = a;
        opt.textContent = a;
        sel.appendChild(opt);
      });
    }

    function actualizarKPIs(ef, pf) {
      var total = ef.length;
      var finalizados = ef.filter(function(e) { return e.estado === 'finalizado'; });
      var exitosos = finalizados.filter(function(e) { return e.exito; });
      var tasaExito = finalizados.length > 0 ? ((exitosos.length / finalizados.length) * 100).toFixed(1) : 0;

      var roiList = ef.filter(function(e) { return typeof e.roi_estimado === 'number' && e.roi_estimado > 0; });
      var roiProm = roiList.length ? (roiList.reduce(function(s,e) { return s + e.roi_estimado; }, 0) / roiList.length).toFixed(1) : 0;

      var duraciones = finalizados.map(function(e) {
        var inicio = new Date(e.fecha_inicio);
        var fin = e.fecha_final_real ? new Date(e.fecha_final_real) : new Date(e.fecha_fin_estimado);
        return Math.max(0, Math.round((fin - inicio) / (1000 * 60 * 60 * 24)));
      }).filter(function(d) { return d > 0; });
      var durProm = duraciones.length ? Math.round(duraciones.reduce(function(a,b) { return a+b; }, 0) / duraciones.length) : 0;

      var probAbiertos = pf.filter(function(p) { return p.estado === 'abierto' || p.estado === 'en proceso'; }).length;

      document.getElementById('kpiTotal').textContent = total;
      document.getElementById('kpiTotalDetalle').textContent = finalizados.length + ' finalizados, ' + ef.filter(function(e) { return e.estado === 'activo'; }).length + ' activos';

      document.getElementById('kpiExito').textContent = tasaExito + '%';
      document.getElementById('kpiExitoDetalle').textContent = exitosos.length + '/' + finalizados.length + ' finalizados con √©xito';

      document.getElementById('kpiRoi').textContent = roiProm + '%';
      document.getElementById('kpiRoiDetalle').textContent = roiList.length + ' ensayos con ROI estimado';

      document.getElementById('kpiDuracion').textContent = durProm + 'd';
      document.getElementById('kpiDuracionDetalle').textContent = duraciones.length + ' ensayos con fechas completas';

      document.getElementById('kpiProblemas').textContent = probAbiertos;
      document.getElementById('kpiProblemasDetalle').textContent = pf.length + ' problemas totales';

      document.getElementById('kpiHistorias').textContent = historias.length;
      document.getElementById('kpiHistoriasDetalle').textContent = historias.filter(function(h) { return h.visible_en_home; }).length + ' destacadas';
    }

    function crearOActualizarChart(id, config) {
      var ctx = document.getElementById(id).getContext('2d');
      if (charts[id]) charts[id].destroy();
      charts[id] = new Chart(ctx, config);
    }

    function actualizarGraficos(ef, pf) {
      var estados = {};
      ef.forEach(function(e) { var est = e.estado || 'sin estado'; estados[est] = (estados[est] || 0) + 1; });
      var coloresEstado = { activo: '#4caf50', finalizado: '#2196f3', suspendido: '#ff9800', fallido: '#f44336' };
      crearOActualizarChart('chartEstado', {
        type: 'doughnut',
        data: {
          labels: Object.keys(estados),
          datasets: [{ data: Object.values(estados), backgroundColor: Object.keys(estados).map(function(e) { return coloresEstado[e] || '#9e9e9e'; }) }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });

      var areas = {};
      ef.forEach(function(e) { var a = e.area || 'Otro'; areas[a] = (areas[a] || 0) + 1; });
      var coloresArea = ['#4caf50','#8bc34a','#cddc39','#f9a825','#ff9800','#2196f3','#9c27b0'];
      crearOActualizarChart('chartArea', {
        type: 'bar',
        data: {
          labels: Object.keys(areas),
          datasets: [{ label: 'Ensayos', data: Object.values(areas), backgroundColor: coloresArea.slice(0, Object.keys(areas).length) }]
        },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });

      var roiPorArea = {};
      ef.filter(function(e) { return typeof e.roi_estimado === 'number' && e.roi_estimado > 0; }).forEach(function(e) {
        var a = e.area || 'Otro';
        if (!roiPorArea[a]) roiPorArea[a] = [];
        roiPorArea[a].push(e.roi_estimado);
      });
      var roiLabels = Object.keys(roiPorArea);
      var roiData = roiLabels.map(function(a) {
        var arr = roiPorArea[a];
        return (arr.reduce(function(s,v) { return s+v; }, 0) / arr.length).toFixed(1);
      });
      crearOActualizarChart('chartRoiArea', {
        type: 'bar',
        data: {
          labels: roiLabels,
          datasets: [{ label: 'ROI Promedio %', data: roiData, backgroundColor: '#f9a825' }]
        },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });

      var prioridades = { Baja: 0, Media: 0, Alta: 0 };
      ef.forEach(function(e) { if (prioridades.hasOwnProperty(e.prioridad)) prioridades[e.prioridad]++; });
      crearOActualizarChart('chartPrioridad', {
        type: 'pie',
        data: {
          labels: Object.keys(prioridades),
          datasets: [{ data: Object.values(prioridades), backgroundColor: ['#4caf50','#ff9800','#f44336'] }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });

      var meses = {};
      ef.forEach(function(e) {
        if (e.fecha_inicio) {
          var m = e.fecha_inicio.substring(0, 7);
          meses[m] = (meses[m] || 0) + 1;
        }
      });
      var mesesOrdenados = Object.keys(meses).sort();
      crearOActualizarChart('chartTimeline', {
        type: 'line',
        data: {
          labels: mesesOrdenados,
          datasets: [{
            label: 'Ensayos creados',
            data: mesesOrdenados.map(function(m) { return meses[m]; }),
            borderColor: '#4caf50',
            backgroundColor: 'rgba(76,175,80,0.1)',
            fill: true,
            tension: 0.3
          }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });

      var probAreas = {};
      pf.forEach(function(p) { var a = p.area || 'Otro'; probAreas[a] = (probAreas[a] || 0) + 1; });
      crearOActualizarChart('chartProblemasArea', {
        type: 'bar',
        data: {
          labels: Object.keys(probAreas),
          datasets: [{ label: 'Problemas', data: Object.values(probAreas), backgroundColor: '#f44336' }]
        },
        options: { responsive: true, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } }
      });

      var topColab = colaboradores.slice()
        .sort(function(a,b) { return (b.aportes || 0) - (a.aportes || 0); })
        .slice(0, 10);
      crearOActualizarChart('chartTopColaboradores', {
        type: 'bar',
        data: {
          labels: topColab.map(function(c) { return c.nombre; }),
          datasets: [{ label: 'Aportes', data: topColab.map(function(c) { return c.aportes || 0; }), backgroundColor: '#2196f3' }]
        },
        options: { responsive: true, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } }
      });
    }

    function generarInsights(ef, pf) {
      var container = document.getElementById('insightsContainer');
      container.innerHTML = '';
      var insights = [];

      var areaActivos = {};
      ef.filter(function(e) { return e.estado === 'activo'; }).forEach(function(e) {
        var a = e.area || 'Otro';
        areaActivos[a] = (areaActivos[a] || 0) + 1;
      });
      var topArea = Object.keys(areaActivos).sort(function(a,b) { return areaActivos[b] - areaActivos[a]; })[0];
      if (topArea) {
        insights.push({
          titulo: 'üî¨ √Årea m√°s activa',
          texto: '"' + topArea + '" tiene ' + areaActivos[topArea] + ' ensayos activos, siendo el √°rea con mayor actividad de investigaci√≥n.'
        });
      }

      var topRoi = ef.filter(function(e) { return e.roi_estimado > 0; }).sort(function(a,b) { return b.roi_estimado - a.roi_estimado; })[0];
      if (topRoi) {
        insights.push({
          titulo: 'üí∞ Mayor ROI estimado',
          texto: 'El ensayo "' + (topRoi.metrica_objetivo || topRoi.id) + '" en ' + topRoi.area + ' tiene un ROI estimado de ' + topRoi.roi_estimado + '%, el m√°s alto registrado.'
        });
      }

      var altaPrioridad = pf.filter(function(p) { return p.prioridad === 'Alta' && (p.estado === 'abierto' || p.estado === 'en proceso'); });
      if (altaPrioridad.length > 0) {
        insights.push({
          titulo: 'üö® Alerta de problemas',
          texto: 'Hay ' + altaPrioridad.length + ' problema(s) de alta prioridad abiertos que requieren atenci√≥n inmediata.'
        });
      }

      var sinAvance = ef.filter(function(e) { return e.estado === 'activo' && (e.porcentaje_avance || 0) === 0; });
      if (sinAvance.length > 0) {
        insights.push({
          titulo: '‚è∏Ô∏è Ensayos sin avance',
          texto: sinAvance.length + ' ensayo(s) activo(s) muestran 0% de avance. Verifica si necesitan atenci√≥n o reasignaci√≥n.'
        });
      }

      var exitoPorArea = {};
      ef.filter(function(e) { return e.estado === 'finalizado'; }).forEach(function(e) {
        var a = e.area || 'Otro';
        if (!exitoPorArea[a]) exitoPorArea[a] = { total: 0, exito: 0 };
        exitoPorArea[a].total++;
        if (e.exito) exitoPorArea[a].exito++;
      });
      var mejorArea = null;
      var mejorTasa = 0;
      Object.keys(exitoPorArea).forEach(function(a) {
        var tasa = exitoPorArea[a].total > 0 ? (exitoPorArea[a].exito / exitoPorArea[a].total) : 0;
        if (tasa > mejorTasa) { mejorTasa = tasa; mejorArea = a; }
      });
      if (mejorArea && mejorTasa > 0) {
        insights.push({
          titulo: 'üèÜ √Årea m√°s exitosa',
          texto: '"' + mejorArea + '" tiene una tasa de √©xito de ' + (mejorTasa * 100).toFixed(0) + '% en ensayos finalizados.'
        });
      }

      if (insights.length === 0) {
        insights.push({
          titulo: 'üìã Sin datos suficientes',
          texto: 'Agrega m√°s ensayos, problemas e historias para generar insights autom√°ticos.'
        });
      }

      insights.forEach(function(ins) {
        var card = document.createElement('div');
        card.className = 'insight-card';
        card.innerHTML = '<h4>' + ins.titulo + '</h4><p>' + ins.texto + '</p>';
        container.appendChild(card);
      });
    }

    function actualizarTabla(ef) {
      var tbody = document.getElementById('tablaDetalle');
      tbody.innerHTML = '';

      if (ef.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#999;">Sin ensayos para los filtros seleccionados.</td></tr>';
        return;
      }

      ef.sort(function(a,b) { return (b.fecha_inicio || '').localeCompare(a.fecha_inicio || ''); });

      ef.forEach(function(e) {
        var clases = { activo: 'badge-activo', finalizado: 'badge-finalizado', suspendido: 'badge-suspendido', fallido: 'badge-fallido' };
        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' + (e.area || '') + '</td>' +
          '<td>' + (e.metrica_objetivo || '') + '</td>' +
          '<td>' + (e.responsable_id || '') + '</td>' +
          '<td>' + (e.prioridad || '') + '</td>' +
          '<td><span class="badge ' + (clases[e.estado] || '') + '">' + (e.estado || '') + '</span></td>' +
          '<td>' + (e.roi_estimado || 0) + '%</td>' +
          '<td>' + (e.porcentaje_avance || 0) + '%</td>' +
          '<td>' + (e.fecha_inicio ? new Date(e.fecha_inicio).toLocaleDateString('es-DO') : '') + '</td>';
        tbody.appendChild(tr);
      });
    }

    async function actualizarTodo() {
      var ef = filtrarEnsayos();
      var pf = filtrarProblemas();
      actualizarKPIs(ef, pf);
      actualizarGraficos(ef, pf);
      generarInsights(ef, pf);
      actualizarTabla(ef);
    }

    document.addEventListener('DOMContentLoaded', async function() {
      await loadData();
      actualizarSelectAreas();
      actualizarTodo();
    });
  </script>

  <script src="auth-guard.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (window.SESION) {
        document.getElementById('userInfo').textContent = 'üë§ ' + window.SESION.nombre + ' (' + window.SESION.rol + ')';
        if (window.esAdmin()) {
          document.getElementById('btnAdmin').style.display = 'inline-flex';
        }
      }
    });
  </script>
</body>
</html>

